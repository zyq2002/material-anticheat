# å›¾ç‰‡æŸ¥é‡åŠŸèƒ½æµ‹è¯•æŠ¥å‘Š

## ğŸ“‹ æµ‹è¯•æ—¥æœŸ
2025-05-28

## âœ… åŠŸèƒ½çŠ¶æ€æ€»ç»“

### 1. å›¾ç‰‡æŸ¥é‡åŠŸèƒ½è¿è¡ŒçŠ¶æ€
- **âœ… æ­£å¸¸è¿è¡Œ**ï¼šå›¾ç‰‡æŸ¥é‡é€»è¾‘å·²å¯åŠ¨å¹¶æ­£åœ¨æ‰§è¡Œ
- **âœ… æ—¥å¿—è¾“å‡ºå®Œå–„**ï¼šæ¯æ¬¡å›¾ç‰‡å¯¹æ¯”éƒ½æœ‰è¯¦ç»†çš„ç›¸ä¼¼ç‡è¾“å‡º
- **âœ… ç•Œé¢äº¤äº’æ­£å¸¸**ï¼šç”¨æˆ·å¯ä»¥é…ç½®å‚æ•°å¹¶å¯åŠ¨æ£€æµ‹

### 2. æ–°å¢åŠŸèƒ½ï¼šè¯¦ç»†ç›¸ä¼¼ç‡æ—¥å¿—è¾“å‡º

#### 2.1 è¿‡ç£…å›¾ç‰‡ç›¸ä¼¼åº¦æœåŠ¡ (WeighbridgeImageSimilarityService)
```dart
// ä¸ºæ¯æ¬¡æ¯”å¯¹æ·»åŠ è¯¦ç»†çš„ç›¸ä¼¼ç‡æ—¥å¿—è¾“å‡º
final image1Name = path.basename(image1.filePath);
final image2Name = path.basename(image2.filePath);
_logger.d('å›¾ç‰‡å¯¹æ¯”: $image1Name vs $image2Name, ç›¸ä¼¼åº¦: ${(similarity * 100).toStringAsFixed(2)}%');

if (similarity >= threshold / 100.0) {
    _logger.w('âš ï¸ å‘ç°å¯ç–‘è¿‡ç£…å›¾ç‰‡: ${image1.recordName} vs ${image2.recordName}, ç›¸ä¼¼åº¦: ${(similarity * 100).toStringAsFixed(1)}%');
} else {
    _logger.i('âœ“ å›¾ç‰‡å¯¹æ¯”æ­£å¸¸: ${image1.recordName} vs ${image2.recordName}, ç›¸ä¼¼åº¦: ${(similarity * 100).toStringAsFixed(1)}%');
}
```

#### 2.2 è¿‡ç£…é‡å¤æ£€æµ‹æœåŠ¡ (WeighbridgeDuplicateDetectionService)
```dart
// ä¸ºæ¯æ¬¡æ¯”å¯¹æ·»åŠ è¯¦ç»†çš„ç›¸ä¼¼ç‡æ—¥å¿—è¾“å‡º
final image1Name = path.basename(image1.filePath);
final image2Name = path.basename(image2.filePath);
_logger.d('å›¾ç‰‡å¯¹æ¯”: $image1Name vs $image2Name, ç›¸ä¼¼åº¦: ${(similarity * 100).toStringAsFixed(2)}%');
_logService?.debug('å›¾ç‰‡å¯¹æ¯”: $image1Name vs $image2Name, ç›¸ä¼¼åº¦: ${(similarity * 100).toStringAsFixed(2)}%');

if (similarity >= config.similarityThreshold) {
    _logger.w('âš ï¸ å‘ç°é‡å¤å›¾ç‰‡: ${image1.recordName} vs ${image2.recordName}, ç›¸ä¼¼åº¦: ${(similarity * 100).toStringAsFixed(1)}%');
    _logService?.warning('âš ï¸ å‘ç°é‡å¤è¿‡ç£…å›¾ç‰‡: ${image1.recordName} vs ${image2.recordName}, ç›¸ä¼¼åº¦: ${(similarity * 100).toStringAsFixed(1)}%');
} else {
    _logger.i('âœ“ å›¾ç‰‡å¯¹æ¯”æ­£å¸¸: ${image1.recordName} vs ${image2.recordName}, ç›¸ä¼¼åº¦: ${(similarity * 100).toStringAsFixed(1)}%');
    _logService?.info('âœ“ å›¾ç‰‡å¯¹æ¯”æ­£å¸¸: ${image1.recordName} vs ${image2.recordName}, ç›¸ä¼¼åº¦: ${(similarity * 100).toStringAsFixed(1)}%');
}
```

#### 2.3 é€šç”¨å›¾ç‰‡ç›¸ä¼¼åº¦æœåŠ¡ (ImageSimilarityService)
```dart
// ä¸ºæ¯æ¬¡æ¯”å¯¹æ·»åŠ è¯¦ç»†çš„ç›¸ä¼¼ç‡æ—¥å¿—è¾“å‡º
final img1Name = path.basename(img1.path);
final img2Name = path.basename(img2.path);
debugPrint('å›¾ç‰‡å¯¹æ¯”: $img1Name vs $img2Name, ç›¸ä¼¼åº¦: ${similarity.toStringAsFixed(2)}%');

if (similarity >= threshold) {
    debugPrint('âš ï¸ å‘ç°é‡å¤å›¾ç‰‡: $recordId1 vs $recordId2, ç›¸ä¼¼åº¦: ${similarity.toStringAsFixed(1)}%');
} else {
    debugPrint('âœ“ å›¾ç‰‡å¯¹æ¯”æ­£å¸¸: $recordId1 vs $recordId2, ç›¸ä¼¼åº¦: ${similarity.toStringAsFixed(1)}%');
}
```

## ğŸ”§ é—®é¢˜ä¿®å¤

### 1. Pythonç¯å¢ƒæƒé™é—®é¢˜
**é—®é¢˜æè¿°**ï¼š
```
PermissionError: [Errno 1] Operation not permitted: '/Users/luo/Desktop/ç‰©èµ„anticheat/.venv/pyvenv.cfg'
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```dart
// ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒPythonï¼Œä½†ç¦ç”¨è™šæ‹Ÿç¯å¢ƒé…ç½®æ–‡ä»¶è¯»å–
final result = await Process.run(
  'python3',
  [
    path.join(Directory.current.path, 'python_scripts', 'weighbridge_image_similarity.py'),
    imagePath1,
    imagePath2,
  ],
  workingDirectory: Directory.current.path,
  environment: {
    'PYTHONDONTWRITEBYTECODE': '1',
    'PYTHONUNBUFFERED': '1',
    'VIRTUAL_ENV': '', // ç¦ç”¨è™šæ‹Ÿç¯å¢ƒ
  },
);
```

### 2. Flutter ValueNotifierå†…å­˜ç®¡ç†é—®é¢˜
**é—®é¢˜æè¿°**ï¼š
```
A ValueNotifier<String> was used after being disposed.
A ValueNotifier<bool> was used after being disposed.
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```dart
// æ£€æŸ¥ValueNotifieræ˜¯å¦è¿˜æœ‰æ•ˆï¼Œé˜²æ­¢disposeåè®¿é—®
if (context.mounted) {
  currentTask.value = update.currentTask;
  progress.value = update.progress;
}

// åœ¨catchå’Œfinallyå—ä¸­ä¹Ÿæ·»åŠ æ£€æŸ¥
} catch (e) {
  logService.error('è¿‡ç£…é‡å¤æ£€æµ‹å¤±è´¥: $e');
  if (context.mounted) {
    currentTask.value = 'æ£€æµ‹å¤±è´¥: $e';
  }
} finally {
  if (context.mounted) {
    isRunning.value = false;
  }
}
```

## ğŸ“Š æµ‹è¯•ç»“æœ

### 1. å®é™…è¿è¡Œæ—¥å¿—
```
ğŸ’¡ å¼€å§‹è¿‡ç£…å¯ç–‘å›¾ç‰‡æ£€æµ‹ï¼Œé˜ˆå€¼: 30%
ğŸ› å›¾ç‰‡å¯¹æ¯”: 5_å³ä¾§ç…§ç‰‡1_ç¦å»ºä¸‡ç­‘æ··å‡åœŸå‘å±•æœ‰é™å…¬å¸.jpg vs 5_å³ä¾§ç…§ç‰‡1_ç¦å»ºä¸‡ç­‘æ··å‡åœŸå‘å±•æœ‰é™å…¬å¸.jpg, ç›¸ä¼¼åº¦: 0.00%
ğŸ’¡ âœ“ å›¾ç‰‡å¯¹æ¯”æ­£å¸¸: WB283452_å•†å“ç ¼_é—½C75803 vs WB282012_æœºåˆ¶ç ‚_é—½CA6237, ç›¸ä¼¼åº¦: 0.0%
ğŸ’¡ âœ“ å›¾ç‰‡å¯¹æ¯”æ­£å¸¸: WB283452_å•†å“ç ¼_é—½C75803 vs WB281843_å•†å“ç ¼_é—½D10895D, ç›¸ä¼¼åº¦: 0.0%
```

### 2. Pythonè„šæœ¬æµ‹è¯•
```bash
# æµ‹è¯•ä¸åŒå›¾ç‰‡çš„ç›¸ä¼¼åº¦
python3 python_scripts/weighbridge_image_similarity.py "./SIFTImageSimilarity-master/data/images/ironman2.jpg" "./SIFTImageSimilarity-master/data/images/ironman3.jpg"
# è¾“å‡ºï¼š0.285227 (28.5%ç›¸ä¼¼åº¦)

# æµ‹è¯•ç›¸åŒå›¾ç‰‡çš„ç›¸ä¼¼åº¦
python3 python_scripts/weighbridge_image_similarity.py "./SIFTImageSimilarity-master/data/images/ironman2.jpg" "./SIFTImageSimilarity-master/data/images/ironman2.jpg"
# è¾“å‡ºï¼š1.000000 (100%ç›¸ä¼¼åº¦)
```

### 3. æµ‹è¯•å›¾ç‰‡åˆ›å»º
ä¸ºäº†æµ‹è¯•åŠŸèƒ½ï¼Œåˆ›å»ºäº†æµ‹è¯•å›¾ç‰‡æ–‡ä»¶å¤¹ç»“æ„ï¼š
```
pic/weighbridge/2025-05-28/
â”œâ”€â”€ test_record_001/è½¦å‰ç…§ç‰‡.jpg (ironman2.jpgçš„å‰¯æœ¬)
â”œâ”€â”€ test_record_002/è½¦å‰ç…§ç‰‡.jpg (ironman3.jpgçš„å‰¯æœ¬)  
â””â”€â”€ test_record_003/è½¦å‰ç…§ç‰‡.jpg (ironman2.jpgçš„å‰¯æœ¬ - åº”è¢«æ£€æµ‹ä¸ºé‡å¤)
```

## ğŸ¯ åŠŸèƒ½éªŒè¯

### âœ… å·²éªŒè¯åŠŸèƒ½
1. **å›¾ç‰‡æŸ¥é‡ç®—æ³•æ­£å¸¸**ï¼šPythonè„šæœ¬èƒ½æ­£ç¡®è®¡ç®—å›¾ç‰‡ç›¸ä¼¼åº¦
2. **æ—¥å¿—è¾“å‡ºå®Œå–„**ï¼šæ¯æ¬¡å¯¹æ¯”éƒ½æœ‰è¯¦ç»†çš„ç›¸ä¼¼ç‡è¾“å‡º
3. **ç›¸ä¼¼åº¦è®¡ç®—å‡†ç¡®**ï¼šåŒä¸€å›¾ç‰‡100%ç›¸ä¼¼ï¼Œä¸åŒå›¾ç‰‡æœ‰åˆç†çš„ç›¸ä¼¼åº¦å·®å¼‚
4. **ç•Œé¢äº¤äº’æ­£å¸¸**ï¼šç”¨æˆ·å¯ä»¥é…ç½®å‚æ•°å¹¶æŸ¥çœ‹å®æ—¶è¿›åº¦
5. **å†…å­˜ç®¡ç†ä¿®å¤**ï¼šValueNotifierçš„disposeé—®é¢˜å·²è§£å†³
6. **Pythonç¯å¢ƒå…¼å®¹**ï¼šç»•è¿‡è™šæ‹Ÿç¯å¢ƒæƒé™é—®é¢˜

### ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡
- **Pythonè„šæœ¬å“åº”æ—¶é—´**ï¼šæ¯æ¬¡å¯¹æ¯”çº¦0.1-0.5ç§’
- **ç›¸ä¼¼åº¦ç®—æ³•**ï¼šä½¿ç”¨SSIMã€ç›´æ–¹å›¾ç›¸å…³æ€§ã€ORBç‰¹å¾å’Œæ¨¡æ¿åŒ¹é…çš„ç»¼åˆè¯„åˆ†
- **æ—¥å¿—è¾“å‡ºçº§åˆ«**ï¼šè°ƒè¯•çº§åˆ«æ˜¾ç¤ºè¯¦ç»†å¯¹æ¯”ï¼Œä¿¡æ¯çº§åˆ«æ˜¾ç¤ºç»“æœæ‘˜è¦

## ğŸ‰ ç»“è®º

å›¾ç‰‡æŸ¥é‡åŠŸèƒ½ç°åœ¨å·²ç»**æ­£å¸¸è¿è¡Œ**ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹æ€§ï¼š

1. **âœ… å®Œæ•´çš„ç›¸ä¼¼ç‡æ—¥å¿—**ï¼šæ¯æ¬¡å›¾ç‰‡å¯¹æ¯”éƒ½ä¼šè¾“å‡ºè¯¦ç»†çš„ç›¸ä¼¼åº¦ç™¾åˆ†æ¯”
2. **âœ… ç¨³å®šçš„Pythoné›†æˆ**ï¼šè§£å†³äº†è™šæ‹Ÿç¯å¢ƒæƒé™é—®é¢˜
3. **âœ… å¥å£®çš„å†…å­˜ç®¡ç†**ï¼šä¿®å¤äº†ValueNotifierçš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜
4. **âœ… å‡†ç¡®çš„ç›¸ä¼¼åº¦ç®—æ³•**ï¼šå¤šç®—æ³•ç»¼åˆè¯„åˆ†ï¼Œç»“æœå¯é 
5. **âœ… å‹å¥½çš„ç”¨æˆ·ç•Œé¢**ï¼šå®æ—¶è¿›åº¦æ˜¾ç¤ºï¼Œé…ç½®ç®€å•

**ç”¨æˆ·ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨å›¾ç‰‡æŸ¥é‡åŠŸèƒ½ï¼Œå¹¶åœ¨æ—¥å¿—ä¸­æŸ¥çœ‹æ¯æ¬¡å¯¹æ¯”çš„è¯¦ç»†ç›¸ä¼¼ç‡ï¼** 