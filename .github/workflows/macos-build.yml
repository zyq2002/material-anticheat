name: Build macOS App

on:
  push:
    branches: [ main, master ]
    tags: 
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'æ˜¯å¦åˆ›å»º Release'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  FLUTTER_VERSION: '3.24.0'
  PYTHON_VERSION: '3.11'

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: è®¾ç½® Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        cache-key: flutter-${{ env.FLUTTER_VERSION }}
        
    - name: Flutter ç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          ~/.pub-cache
          ${{ runner.tool_cache }}/flutter
        key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-
          ${{ runner.os }}-flutter-
        
    - name: å¯ç”¨ macOS æ¡Œé¢æ”¯æŒ
      run: flutter config --enable-macos-desktop
      
    - name: æ£€æŸ¥ Flutter çŠ¶æ€
      run: flutter doctor -v
      
    - name: èŽ·å–ä¾èµ–
      run: flutter pub get
      
    - name: ä»£ç ç”Ÿæˆ
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: åˆ†æžä»£ç 
      run: flutter analyze
      continue-on-error: true
      
    - name: è¿è¡Œæµ‹è¯•
      run: flutter test
      continue-on-error: true
      
    - name: æž„å»º macOS åº”ç”¨
      run: flutter build macos --release --verbose
      
    - name: éªŒè¯æž„å»ºç»“æžœ
      run: |
        if [ -d "build/macos/Build/Products/Release/material_anticheat.app" ]; then
          echo "âœ… macOSåº”ç”¨æž„å»ºæˆåŠŸ"
          ls -la build/macos/Build/Products/Release/
          echo ""
          echo "ðŸ“ æž„å»ºäº§ç‰©è¯¦æƒ…:"
          find build/macos/Build/Products/Release/ -type f | head -20
        else
          echo "âŒ æž„å»ºå¤±è´¥ - appæ–‡ä»¶ä¸å­˜åœ¨"
          echo "ðŸ“‚ å½“å‰æž„å»ºç›®å½•å†…å®¹:"
          if [ -d "build/macos" ]; then
            find build/macos -type f -name "*.app" 2>/dev/null || echo "æœªæ‰¾åˆ°.appæ–‡ä»¶"
            ls -la build/macos/Build/Products/ 2>/dev/null || echo "Releaseç›®å½•ä¸å­˜åœ¨"
          else
            echo "build/macos ç›®å½•ä¸å­˜åœ¨"
          fi
          exit 1
        fi
        
    - name: åˆ›å»ºåº”ç”¨åŒ…
      run: |
        echo "ðŸ“¦ åˆ›å»ºåº”ç”¨åŒ…..."
        rm -rf macos-package
        mkdir -p macos-package
        
        echo "ðŸ“ å¤åˆ¶ä¸»ç¨‹åºæ–‡ä»¶..."
        cp -R build/macos/Build/Products/Release/material_anticheat.app macos-package/
        
        echo "ðŸ“„ å¤åˆ¶ README å’Œè¯´æ˜Žæ–‡ä»¶..."
        if [ -f "README_WINDOWS.md" ]; then
          cp README_WINDOWS.md macos-package/README.md
        fi
        if [ -f "ç‰©èµ„anticheat-å‘å¸ƒè¯´æ˜Ž.md" ]; then
          cp "ç‰©èµ„anticheat-å‘å¸ƒè¯´æ˜Ž.md" macos-package/
        fi
        
        echo "ðŸ“ å¤åˆ¶ Python è„šæœ¬ (å¦‚æžœå­˜åœ¨)..."
        if [ -d "python_scripts" ]; then
          mkdir -p macos-package/python_scripts
          cp -R python_scripts/* macos-package/python_scripts/
        fi
        
        echo "âœ… åº”ç”¨åŒ…åˆ›å»ºå®Œæˆ"
        ls -la macos-package/
        
    - name: åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
      run: |
        echo "ðŸ“ åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶..."
        cat > macos-package/VERSION.txt << EOF
        ç‰©èµ„anticheat macOSç‰ˆæœ¬
        æž„å»ºæ—¶é—´: $(date)
        æž„å»ºåˆ†æ”¯: ${{ github.ref_name }}
        æäº¤å“ˆå¸Œ: ${{ github.sha }}
        Flutterç‰ˆæœ¬: ${{ env.FLUTTER_VERSION }}
        
        è¿è¡Œè¯´æ˜Ž:
        1. åŒå‡» material_anticheat.app å¯åŠ¨åº”ç”¨
        2. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸è¿è¡Œ
        3. å¦‚é‡æƒé™é—®é¢˜ï¼Œå³é”®é€‰æ‹©"æ‰“å¼€"
        4. é¦–æ¬¡è¿è¡Œéœ€è¦é…ç½®æŽ¥å£åœ°å€å’Œè®¤è¯ä¿¡æ¯
        EOF
        
    - name: åˆ›å»ºå®‰è£…è„šæœ¬
      run: |
        echo "ðŸ“ åˆ›å»ºå®‰è£…è„šæœ¬..."
        cat > macos-package/install.sh << 'EOF'
        #!/bin/bash
        echo "ðŸš€ ç‰©èµ„anticheat macOS å®‰è£…è„šæœ¬"
        echo ""
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æƒé™
        if [ ! -w "/Applications" ]; then
            echo "âŒ éœ€è¦ç®¡ç†å‘˜æƒé™å®‰è£…åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹"
            echo "è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š"
            sudo cp -R material_anticheat.app /Applications/
        else
            cp -R material_anticheat.app /Applications/
        fi
        
        if [ $? -eq 0 ]; then
            echo "âœ… å®‰è£…æˆåŠŸï¼"
            echo "ðŸ“± åº”ç”¨å·²å®‰è£…åˆ° /Applications/material_anticheat.app"
            echo "ðŸŽ¯ æ‚¨çŽ°åœ¨å¯ä»¥åœ¨å¯åŠ¨å°æˆ–åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ç‰©èµ„anticheat"
        else
            echo "âŒ å®‰è£…å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹"
        fi
        EOF
        chmod +x macos-package/install.sh
        
    - name: åŽ‹ç¼©åº”ç”¨åŒ…
      run: |
        echo "ðŸ—œï¸ åˆ›å»ºåŽ‹ç¼©åŒ…..."
        rm -f material-anticheat-macos.zip
        cd macos-package && zip -r ../material-anticheat-macos.zip . && cd ..
        
        echo "âœ… åŽ‹ç¼©åŒ…åˆ›å»ºå®Œæˆ"
        ls -la material-anticheat-macos.zip
        echo "ðŸ“Š æ–‡ä»¶å¤§å°: $(du -h material-anticheat-macos.zip | cut -f1)"
      
    - name: åˆ›å»º DMG å®‰è£…åŒ…
      run: |
        echo "ðŸ’¿ åˆ›å»ºDMGå®‰è£…åŒ…..."
        
        # åˆ›å»ºä¸´æ—¶DMGç›®å½•
        mkdir -p dmg-temp
        cp -R macos-package/material_anticheat.app dmg-temp/
        
        # åˆ›å»ºApplicationsé“¾æŽ¥
        ln -s /Applications dmg-temp/Applications
        
        # åˆ›å»ºREADME
        cat > dmg-temp/README.txt << EOF
        ç‰©èµ„anticheat - macOSç‰ˆ
        
        å®‰è£…æ–¹æ³•:
        1. å°† material_anticheat.app æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
        2. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸è¿è¡Œ
        3. å¦‚é‡æƒé™é—®é¢˜ï¼Œå³é”®é€‰æ‹©"æ‰“å¼€"
        
        ç³»ç»Ÿè¦æ±‚:
        - macOS 10.14 æˆ–æ›´é«˜ç‰ˆæœ¬
        - 4GB+ å†…å­˜
        - 500MB+ å­˜å‚¨ç©ºé—´
        EOF
        
        # åˆ›å»ºDMG
        hdiutil create -volname "ç‰©èµ„anticheat" -srcfolder dmg-temp -ov -format UDZO material-anticheat-macos.dmg
        
        echo "âœ… DMGåˆ›å»ºå®Œæˆ"
        ls -la material-anticheat-macos.dmg
        echo "ðŸ“Š DMGå¤§å°: $(du -h material-anticheat-macos.dmg | cut -f1)"
        
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: macos-app-${{ github.run_number }}
        path: |
          material-anticheat-macos.zip
          material-anticheat-macos.dmg
        retention-days: 90
        
    - name: ä¸Šä¼ è°ƒè¯•ä¿¡æ¯
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: macos-debug-info-${{ github.run_number }}
        path: |
          build/macos/**/*.log
          flutter_analyze.log
        retention-days: 30
        
    - name: åˆ›å»º Release (å¦‚æžœæ˜¯æ ‡ç­¾æŽ¨é€æˆ–æ‰‹åŠ¨è§¦å‘)
      if: (startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'))
      uses: softprops/action-gh-release@v1
      with:
        files: |
          material-anticheat-macos.zip
          material-anticheat-macos.dmg
        name: ç‰©èµ„anticheat macOSç‰ˆ ${{ github.ref_name }}
        body: |
          ðŸŽ‰ ç‰©èµ„anticheat macOSç‰ˆæœ¬å‘å¸ƒ
          
          ðŸ“¦ **åŒ…å«å†…å®¹:**
          - `material-anticheat-macos.zip` - åº”ç”¨åŒ… (å«å®‰è£…è„šæœ¬)
          - `material-anticheat-macos.dmg` - DMGå®‰è£…åŒ… (æŽ¨è)
          
          ðŸš€ **ç³»ç»Ÿè¦æ±‚:**
          - macOS 10.14 æˆ–æ›´é«˜ç‰ˆæœ¬
          - Intel æˆ– Apple Silicon èŠ¯ç‰‡
          - 4GB+ å†…å­˜
          
          ðŸ“‹ **å®‰è£…è¯´æ˜Ž:**
          
          **æ–¹æ³•1 (æŽ¨è)**: ä½¿ç”¨DMGå®‰è£…åŒ…
          1. ä¸‹è½½å¹¶åŒå‡» `material-anticheat-macos.dmg`
          2. å°†åº”ç”¨æ‹–æ‹½åˆ°Applicationsæ–‡ä»¶å¤¹
          3. é¦–æ¬¡è¿è¡Œå³é”®é€‰æ‹©"æ‰“å¼€"
          
          **æ–¹æ³•2**: ä½¿ç”¨ZIPåŒ…
          1. ä¸‹è½½å¹¶è§£åŽ‹ `material-anticheat-macos.zip`
          2. è¿è¡Œ `install.sh` è„šæœ¬è‡ªåŠ¨å®‰è£…
          3. æˆ–æ‰‹åŠ¨å°†appæ‹–åˆ°Applicationsæ–‡ä»¶å¤¹
          
          ðŸ”§ **æž„å»ºä¿¡æ¯:**
          - æž„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤: ${{ github.sha }}
          - Flutter: ${{ env.FLUTTER_VERSION }}
          
          ðŸ“ **æ›´æ–°å†…å®¹:**
          ${{ github.event.head_commit.message }}
        draft: false
        prerelease: contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 