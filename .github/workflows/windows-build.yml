name: Build Windows App

on:
  push:
    branches: [ main, master ]
    tags: 
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'æ˜¯å¦åˆ›å»º Release'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  FLUTTER_VERSION: '3.24.0'
  PYTHON_VERSION: '3.11'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        if exist requirements.txt pip install -r requirements.txt
      shell: cmd
      
    - name: è®¾ç½® Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        cache-key: flutter-${{ env.FLUTTER_VERSION }}
        
    - name: Flutter ç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          ~/.pub-cache
          ${{ runner.tool_cache }}/flutter
        key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-
          ${{ runner.os }}-flutter-
        
    - name: å¯ç”¨ Windows æ¡Œé¢æ”¯æŒ
      run: flutter config --enable-windows-desktop
      
    - name: æ£€æŸ¥ Flutter çŠ¶æ€
      run: flutter doctor -v
      
    - name: è·å–ä¾èµ–
      run: flutter pub get
      
    - name: ä»£ç ç”Ÿæˆ
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: åˆ†æä»£ç 
      run: flutter analyze
      continue-on-error: true
      
    - name: è¿è¡Œæµ‹è¯•
      run: flutter test
      continue-on-error: true
      
    - name: æ„å»º Windows åº”ç”¨
      run: flutter build windows --release --verbose
      
    - name: éªŒè¯æ„å»ºç»“æœ
      run: |
        if exist "build\windows\x64\runner\Release\material_anticheat.exe" (
          echo âœ… Windowsåº”ç”¨æ„å»ºæˆåŠŸ
          dir "build\windows\x64\runner\Release\"
          echo.
          echo ğŸ“ æ„å»ºäº§ç‰©è¯¦æƒ…:
          for /r "build\windows\x64\runner\Release\" %%i in (*) do echo %%i
        ) else (
          echo âŒ æ„å»ºå¤±è´¥ - å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨
          echo ğŸ“‚ å½“å‰æ„å»ºç›®å½•å†…å®¹:
          if exist "build\windows" (
            dir "build\windows" /s
          ) else (
            echo build\windows ç›®å½•ä¸å­˜åœ¨
          )
          exit 1
        )
      shell: cmd
      
    - name: åˆ›å»ºåº”ç”¨åŒ…
      run: |
        echo ğŸ“¦ åˆ›å»ºåº”ç”¨åŒ…...
        if exist "windows-package" rmdir /s /q "windows-package"
        mkdir windows-package
        
        echo ğŸ“ å¤åˆ¶ä¸»ç¨‹åºæ–‡ä»¶...
        xcopy "build\windows\x64\runner\Release\*" "windows-package\" /s /e /y /i
        
        echo ğŸ“„ å¤åˆ¶ README å’Œè¯´æ˜æ–‡ä»¶...
        if exist "README_WINDOWS.md" copy "README_WINDOWS.md" "windows-package\README.md"
        if exist "ç‰©èµ„anticheat-å‘å¸ƒè¯´æ˜.md" copy "ç‰©èµ„anticheat-å‘å¸ƒè¯´æ˜.md" "windows-package\"
        
        echo ğŸ“ å¤åˆ¶ Python è„šæœ¬ (å¦‚æœå­˜åœ¨)...
        if exist "python_scripts" (
          mkdir "windows-package\python_scripts"
          xcopy "python_scripts\*" "windows-package\python_scripts\" /s /e /y /i
        )
        
        echo âœ… åº”ç”¨åŒ…åˆ›å»ºå®Œæˆ
        dir "windows-package" /s
      shell: cmd
        
    - name: åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
      run: |
        echo ğŸ“ åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶...
        echo ç‰©èµ„anticheat Windowsç‰ˆæœ¬ > windows-package\VERSION.txt
        echo æ„å»ºæ—¶é—´: %date% %time% >> windows-package\VERSION.txt
        echo æ„å»ºåˆ†æ”¯: ${{ github.ref_name }} >> windows-package\VERSION.txt
        echo æäº¤å“ˆå¸Œ: ${{ github.sha }} >> windows-package\VERSION.txt
        echo Flutterç‰ˆæœ¬: ${{ env.FLUTTER_VERSION }} >> windows-package\VERSION.txt
        echo. >> windows-package\VERSION.txt
        echo è¿è¡Œè¯´æ˜: >> windows-package\VERSION.txt
        echo 1. åŒå‡» material_anticheat.exe å¯åŠ¨åº”ç”¨ >> windows-package\VERSION.txt
        echo 2. é¦–æ¬¡è¿è¡Œéœ€è¦é…ç½®æ¥å£åœ°å€å’Œè®¤è¯ä¿¡æ¯ >> windows-package\VERSION.txt
        echo 3. å¦‚æœ‰é—®é¢˜è¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ >> windows-package\VERSION.txt
      shell: cmd
        
    - name: å‹ç¼©åº”ç”¨åŒ…
      run: |
        echo ğŸ—œï¸ åˆ›å»ºå‹ç¼©åŒ…...
        if exist "material-anticheat-windows.zip" del "material-anticheat-windows.zip"
        powershell Compress-Archive -Path "windows-package\*" -DestinationPath "material-anticheat-windows.zip" -CompressionLevel Optimal
        
        echo âœ… å‹ç¼©åŒ…åˆ›å»ºå®Œæˆ
        dir material-anticheat-windows.zip
        powershell Get-ItemProperty material-anticheat-windows.zip | Select-Object Name,Length,LastWriteTime
      shell: cmd
      
    - name: åˆ›å»ºä¾¿æºç‰ˆ
      run: |
        echo ğŸ’¼ åˆ›å»ºä¾¿æºç‰ˆ...
        if exist "material-anticheat-portable" rmdir /s /q "material-anticheat-portable"
        mkdir material-anticheat-portable
        xcopy "windows-package\*" "material-anticheat-portable\" /s /e /y /i
        
        echo @echo off > material-anticheat-portable\å¯åŠ¨åº”ç”¨.bat
        echo cd /d "%%~dp0" >> material-anticheat-portable\å¯åŠ¨åº”ç”¨.bat
        echo material_anticheat.exe >> material-anticheat-portable\å¯åŠ¨åº”ç”¨.bat
        echo pause >> material-anticheat-portable\å¯åŠ¨åº”ç”¨.bat
        
        powershell Compress-Archive -Path "material-anticheat-portable\*" -DestinationPath "material-anticheat-portable.zip" -CompressionLevel Optimal
        echo âœ… ä¾¿æºç‰ˆåˆ›å»ºå®Œæˆ
      shell: cmd
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: windows-app-${{ github.run_number }}
        path: |
          material-anticheat-windows.zip
          material-anticheat-portable.zip
        retention-days: 90
        
    - name: ä¸Šä¼ è°ƒè¯•ä¿¡æ¯
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: debug-info-${{ github.run_number }}
        path: |
          build/windows/**/*.log
          flutter_analyze.log
        retention-days: 30
        
    - name: åˆ›å»º Release (å¦‚æœæ˜¯æ ‡ç­¾æ¨é€æˆ–æ‰‹åŠ¨è§¦å‘)
      if: (startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'))
      uses: softprops/action-gh-release@v1
      with:
        files: |
          material-anticheat-windows.zip
          material-anticheat-portable.zip
        name: ç‰©èµ„anticheat Windowsç‰ˆ ${{ github.ref_name }}
        body: |
          ğŸ‰ ç‰©èµ„anticheat Windowsç‰ˆæœ¬å‘å¸ƒ
          
          ğŸ“¦ **åŒ…å«å†…å®¹:**
          - `material-anticheat-windows.zip` - æ ‡å‡†å®‰è£…åŒ…
          - `material-anticheat-portable.zip` - ä¾¿æºç‰ˆ (åŒ…å«å¯åŠ¨è„šæœ¬)
          
          ğŸš€ **è¿è¡Œè¦æ±‚:**
          - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - x64 æ¶æ„
          
          ğŸ“‹ **ä½¿ç”¨è¯´æ˜:**
          1. ä¸‹è½½å¹¶è§£å‹å¯¹åº”çš„zipæ–‡ä»¶
          2. åŒå‡» `material_anticheat.exe` æˆ–è¿è¡Œ `å¯åŠ¨åº”ç”¨.bat`
          3. é¦–æ¬¡ä½¿ç”¨éœ€è¦é…ç½®æ¥å£ä¿¡æ¯
          
          ğŸ”§ **æ„å»ºä¿¡æ¯:**
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤: ${{ github.sha }}
          - Flutter: ${{ env.FLUTTER_VERSION }}
          
          ğŸ“ **æ›´æ–°å†…å®¹:**
          ${{ github.event.head_commit.message }}
        draft: false
        prerelease: contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}