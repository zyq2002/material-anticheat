name: Build Multi-Platform Apps

on:
  push:
    branches: [ main, master ]
    tags: 
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'æ˜¯å¦åˆ›å»º Release'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  FLUTTER_VERSION: '3.24.0'
  PYTHON_VERSION: '3.11'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            artifact-name: windows-app
            build-cmd: flutter build windows --release --verbose
            verify-path: build/windows/x64/runner/Release/material_anticheat.exe
          - os: macos-latest
            platform: macos
            artifact-name: macos-app
            build-cmd: flutter build macos --release --verbose
            verify-path: build/macos/Build/Products/Release/material_anticheat.app
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£… Python ä¾èµ– (Windows)
      if: matrix.platform == 'windows'
      run: |
        python -m pip install --upgrade pip
        if exist requirements.txt pip install -r requirements.txt
      shell: cmd
      
    - name: å®‰è£… Python ä¾èµ– (macOS)
      if: matrix.platform == 'macos'
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: è®¾ç½® Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        cache-key: flutter-${{ env.FLUTTER_VERSION }}
        
    - name: Flutter ç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          ~/.pub-cache
          ${{ runner.tool_cache }}/flutter
        key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-
          ${{ runner.os }}-flutter-
        
    - name: å¯ç”¨æ¡Œé¢æ”¯æŒ
      run: |
        flutter config --enable-windows-desktop
        flutter config --enable-macos-desktop
      
    - name: æ£€æŸ¥ Flutter çŠ¶æ€
      run: flutter doctor -v
      
    - name: èŽ·å–ä¾èµ–
      run: flutter pub get
      
    - name: ä»£ç ç”Ÿæˆ
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: åˆ†æžä»£ç 
      run: flutter analyze
      continue-on-error: true
      
    - name: è¿è¡Œæµ‹è¯•
      run: flutter test
      continue-on-error: true
      
    - name: æž„å»ºåº”ç”¨
      run: ${{ matrix.build-cmd }}
      
    - name: éªŒè¯æž„å»ºç»“æžœ (Windows)
      if: matrix.platform == 'windows'
      run: |
        if exist "${{ matrix.verify-path }}" (
          echo âœ… Windowsåº”ç”¨æž„å»ºæˆåŠŸ
          dir "build\windows\x64\runner\Release\"
        ) else (
          echo âŒ æž„å»ºå¤±è´¥ - exeæ–‡ä»¶ä¸å­˜åœ¨
          exit 1
        )
      shell: cmd
      
    - name: éªŒè¯æž„å»ºç»“æžœ (macOS)
      if: matrix.platform == 'macos'
      run: |
        if [ -d "${{ matrix.verify-path }}" ]; then
          echo "âœ… macOSåº”ç”¨æž„å»ºæˆåŠŸ"
          ls -la build/macos/Build/Products/Release/
        else
          echo "âŒ æž„å»ºå¤±è´¥ - appæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: æ‰“åŒ… Windows åº”ç”¨
      if: matrix.platform == 'windows'
      run: |
        echo ðŸ“¦ åˆ›å»ºWindowsåº”ç”¨åŒ…...
        if exist "package" rmdir /s /q "package"
        mkdir package
        
        xcopy "build\windows\x64\runner\Release\*" "package\" /s /e /y /i
        
        if exist "README_WINDOWS.md" copy "README_WINDOWS.md" "package\README.md"
        if exist "ç‰©èµ„anticheat-å‘å¸ƒè¯´æ˜Ž.md" copy "ç‰©èµ„anticheat-å‘å¸ƒè¯´æ˜Ž.md" "package\"
        
        echo ç‰©èµ„anticheat Windowsç‰ˆæœ¬ > package\VERSION.txt
        echo æž„å»ºæ—¶é—´: %date% %time% >> package\VERSION.txt
        echo æž„å»ºåˆ†æ”¯: ${{ github.ref_name }} >> package\VERSION.txt
        echo æäº¤å“ˆå¸Œ: ${{ github.sha }} >> package\VERSION.txt
        
        powershell Compress-Archive -Path "package\*" -DestinationPath "material-anticheat-${{ matrix.platform }}.zip" -CompressionLevel Optimal
        
        REM åˆ›å»ºä¾¿æºç‰ˆ
        if exist "portable" rmdir /s /q "portable"
        mkdir portable
        xcopy "package\*" "portable\" /s /e /y /i
        echo @echo off > portable\å¯åŠ¨åº”ç”¨.bat
        echo cd /d "%%~dp0" >> portable\å¯åŠ¨åº”ç”¨.bat
        echo material_anticheat.exe >> portable\å¯åŠ¨åº”ç”¨.bat
        echo pause >> portable\å¯åŠ¨åº”ç”¨.bat
        
        powershell Compress-Archive -Path "portable\*" -DestinationPath "material-anticheat-${{ matrix.platform }}-portable.zip" -CompressionLevel Optimal
      shell: cmd
        
    - name: æ‰“åŒ… macOS åº”ç”¨
      if: matrix.platform == 'macos'
      run: |
        echo "ðŸ“¦ åˆ›å»ºmacOSåº”ç”¨åŒ…..."
        rm -rf package
        mkdir -p package
        
        cp -R "${{ matrix.verify-path }}" package/
        
        if [ -f "README_WINDOWS.md" ]; then
          cp README_WINDOWS.md package/README.md
        fi
        if [ -f "ç‰©èµ„anticheat-å‘å¸ƒè¯´æ˜Ž.md" ]; then
          cp "ç‰©èµ„anticheat-å‘å¸ƒè¯´æ˜Ž.md" package/
        fi
        
        cat > package/VERSION.txt << EOF
        ç‰©èµ„anticheat macOSç‰ˆæœ¬
        æž„å»ºæ—¶é—´: $(date)
        æž„å»ºåˆ†æ”¯: ${{ github.ref_name }}
        æäº¤å“ˆå¸Œ: ${{ github.sha }}
        Flutterç‰ˆæœ¬: ${{ env.FLUTTER_VERSION }}
        EOF
        
        # åˆ›å»ºå®‰è£…è„šæœ¬
        cat > package/install.sh << 'EOF'
        #!/bin/bash
        echo "ðŸš€ ç‰©èµ„anticheat macOS å®‰è£…è„šæœ¬"
        if [ ! -w "/Applications" ]; then
            echo "éœ€è¦ç®¡ç†å‘˜æƒé™..."
            sudo cp -R material_anticheat.app /Applications/
        else
            cp -R material_anticheat.app /Applications/
        fi
        echo "âœ… å®‰è£…å®Œæˆï¼"
        EOF
        chmod +x package/install.sh
        
        # åˆ›å»ºZIPåŒ…
        cd package && zip -r ../material-anticheat-${{ matrix.platform }}.zip . && cd ..
        
        # åˆ›å»ºDMG
        mkdir -p dmg-temp
        cp -R package/material_anticheat.app dmg-temp/
        ln -s /Applications dmg-temp/Applications
        hdiutil create -volname "ç‰©èµ„anticheat" -srcfolder dmg-temp -ov -format UDZO material-anticheat-${{ matrix.platform }}.dmg
        
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}-${{ github.run_number }}
        path: |
          material-anticheat-${{ matrix.platform }}.*
        retention-days: 90
        
  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: (startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'))
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release-files
        find artifacts -name "*.zip" -o -name "*.dmg" | xargs -I {} cp {} release-files/
        ls -la release-files/
        
    - name: åˆ›å»º Release
      uses: softprops/action-gh-release@v1
      with:
        files: release-files/*
        name: ç‰©èµ„anticheat è·¨å¹³å°ç‰ˆ ${{ github.ref_name }}
        body: |
          ðŸŽ‰ ç‰©èµ„anticheat è·¨å¹³å°ç‰ˆæœ¬å‘å¸ƒ
          
          ðŸ“¦ **åŒ…å«å†…å®¹:**
          
          **Windowsç‰ˆæœ¬:**
          - `material-anticheat-windows.zip` - æ ‡å‡†ç‰ˆ
          - `material-anticheat-windows-portable.zip` - ä¾¿æºç‰ˆ
          
          **macOSç‰ˆæœ¬:**
          - `material-anticheat-macos.zip` - åº”ç”¨åŒ…
          - `material-anticheat-macos.dmg` - DMGå®‰è£…åŒ… (æŽ¨è)
          
          ðŸš€ **ç³»ç»Ÿè¦æ±‚:**
          - **Windows**: Windows 10+ (x64)
          - **macOS**: macOS 10.14+ (Intel/Apple Silicon)
          - 4GB+ å†…å­˜ï¼Œ500MB+ å­˜å‚¨ç©ºé—´
          
          ðŸ“‹ **å®‰è£…è¯´æ˜Ž:**
          
          **Windowsç”¨æˆ·:**
          1. ä¸‹è½½å¹¶è§£åŽ‹å¯¹åº”zipæ–‡ä»¶
          2. åŒå‡» `material_anticheat.exe` å¯åŠ¨
          3. ä¾¿æºç‰ˆåŒ…å« `å¯åŠ¨åº”ç”¨.bat` è„šæœ¬
          
          **macOSç”¨æˆ·:**
          1. æŽ¨èä¸‹è½½DMGæ–‡ä»¶ï¼Œæ‹–æ‹½å®‰è£…
          2. æˆ–è§£åŽ‹ZIPæ–‡ä»¶ï¼Œè¿è¡Œ `install.sh`
          3. é¦–æ¬¡è¿è¡Œå³é”®é€‰æ‹©"æ‰“å¼€"
          
          ðŸ”§ **æž„å»ºä¿¡æ¯:**
          - æž„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤: ${{ github.sha }}
          - Flutter: ${{ env.FLUTTER_VERSION }}
          
          ðŸ“ **æ›´æ–°å†…å®¹:**
          ${{ github.event.head_commit.message }}
        draft: false
        prerelease: contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 