name: Build Windows Only

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python (Pythonè„šæœ¬æ”¯æŒ)
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        if (Test-Path "python_scripts/requirements.txt") {
          pip install -r python_scripts/requirements.txt
        } else {
          echo "è­¦å‘Š: python_scripts/requirements.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡Pythonä¾èµ–å®‰è£…"
        }
      shell: powershell
      
    - name: è®¾ç½® Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: éªŒè¯é¡¹ç›®ç»“æ„å’Œç¯å¢ƒ
      run: |
        echo "=== å½“å‰å·¥ä½œç›®å½• ==="
        pwd
        echo ""
        echo "=== ç›®å½•å†…å®¹ ==="
        Get-ChildItem | Format-Table Name, Length, LastWriteTime
        echo ""
        echo "=== æ£€æŸ¥å…³é”®æ–‡ä»¶ ==="
        if (Test-Path "pubspec.yaml") { 
          echo "âœ… pubspec.yaml å­˜åœ¨" 
        } else { 
          echo "âŒ pubspec.yaml ä¸å­˜åœ¨" 
          exit 1
        }
        echo ""
        echo "=== Flutter ç‰ˆæœ¬ä¿¡æ¯ ==="
        flutter --version
      shell: powershell
        
    - name: å¯ç”¨ Windows æ¡Œé¢æ”¯æŒ
      run: flutter config --enable-windows-desktop
      
    - name: æ¸…ç†å¹¶è·å–ä¾èµ–
      run: |
        echo "=== æ¸…ç†é¡¹ç›® ==="
        flutter clean
        echo ""
        echo "=== è·å–ä¾èµ– ==="
        flutter pub get
      
    - name: åˆ†æä»£ç  (å¯é€‰)
      run: flutter analyze
      continue-on-error: true
      
    - name: æ„å»º Windows åº”ç”¨
      run: |
        echo "=== å¼€å§‹æ„å»º Windows åº”ç”¨ ==="
        flutter build windows --release --verbose
      
    - name: éªŒè¯æ„å»ºç»“æœ
      run: |
        echo "=== æ£€æŸ¥æ„å»ºç›®å½• ==="
        $buildPath = "build/windows/x64/runner/Release"
        if (Test-Path $buildPath) {
          echo "âœ… æ„å»ºç›®å½•å­˜åœ¨: $buildPath"
          echo ""
          echo "=== æ„å»ºäº§ç‰©åˆ—è¡¨ ==="
          Get-ChildItem $buildPath -Recurse | Format-Table Name, Length, LastWriteTime
          echo ""
          echo "=== å¯æ‰§è¡Œæ–‡ä»¶æ£€æŸ¥ ==="
          $exeFiles = Get-ChildItem $buildPath -Filter "*.exe" -Recurse
          if ($exeFiles.Count -gt 0) {
            echo "âœ… æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶:"
            foreach ($file in $exeFiles) {
              echo "  - $($file.FullName)"
            }
          } else {
            echo "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          }
        } else {
          echo "âŒ æ„å»ºç›®å½•ä¸å­˜åœ¨: $buildPath"
          exit 1
        }
      shell: powershell
      
    - name: åˆ›å»º Windows åº”ç”¨åŒ…
      run: |
        $sourceDir = "build/windows/x64/runner/Release"
        $packageDir = "ç‰©èµ„anticheat-windows"
        
        echo "=== åˆ›å»ºåº”ç”¨åŒ… ==="
        if (Test-Path $packageDir) { 
          Remove-Item $packageDir -Recurse -Force 
        }
        New-Item -ItemType Directory -Path $packageDir -Force
        
        echo "=== å¤åˆ¶æ–‡ä»¶ ==="
        Copy-Item -Path "$sourceDir/*" -Destination $packageDir -Recurse -Force
        
        echo "=== éªŒè¯åº”ç”¨åŒ… ==="
        if (Test-Path $packageDir) {
          echo "âœ… åº”ç”¨åŒ…åˆ›å»ºæˆåŠŸ"
          Get-ChildItem $packageDir | Format-Table Name, Length, LastWriteTime
        } else {
          echo "âŒ åº”ç”¨åŒ…åˆ›å»ºå¤±è´¥"
          exit 1
        }
      shell: powershell
        
    - name: å‹ç¼©åº”ç”¨
      run: |
        $packageDir = "ç‰©èµ„anticheat-windows"
        $zipName = "ç‰©èµ„anticheat-windows-x64.zip"
        
        echo "=== åˆ›å»ºå‹ç¼©åŒ… ==="
        if (Test-Path $zipName) { 
          Remove-Item $zipName -Force 
        }
        
        Compress-Archive -Path "$packageDir/*" -DestinationPath $zipName -Force
        
        echo "=== éªŒè¯å‹ç¼©åŒ… ==="
        if (Test-Path $zipName) {
          $zipInfo = Get-Item $zipName
          echo "âœ… å‹ç¼©åŒ…åˆ›å»ºæˆåŠŸ"
          echo "   æ–‡ä»¶å: $($zipInfo.Name)"
          echo "   å¤§å°: $([math]::Round($zipInfo.Length/1MB,2)) MB"
          echo "   åˆ›å»ºæ—¶é—´: $($zipInfo.CreationTime)"
        } else {
          echo "âŒ å‹ç¼©åŒ…åˆ›å»ºå¤±è´¥"
          exit 1
        }
      shell: powershell
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: windows-build-only
        path: ç‰©èµ„anticheat-windows-x64.zip
        retention-days: 30
        
    - name: æ„å»ºæ‘˜è¦
      run: |
        echo "=== æ„å»ºå®Œæˆæ‘˜è¦ ==="
        echo "âœ… Windows åº”ç”¨æ„å»ºæˆåŠŸ"
        echo "ğŸ“¦ æ„å»ºäº§ç‰©: ç‰©èµ„anticheat-windows-x64.zip"
        echo "ğŸ•’ æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        echo ""
        echo "=== ä¸‹è½½è¯´æ˜ ==="
        echo "1. è¿›å…¥ GitHub Actions é¡µé¢"
        echo "2. æ‰¾åˆ°æ­¤æ¬¡æ„å»ºè®°å½•"
        echo "3. ä¸‹è½½ 'windows-build-only' æ„å»ºäº§ç‰©"
        echo "4. è§£å‹åå³å¯ä½¿ç”¨"
      shell: powershell