name: Build Multi-Platform Flutter App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: å¯ç”¨ Windows æ¡Œé¢æ”¯æŒ
      run: flutter config --enable-windows-desktop
    
    - name: éªŒè¯é¡¹ç›®ç»“æ„
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•:"
        pwd
        echo "ç›®å½•å†…å®¹:"
        dir
        echo "æ£€æŸ¥pubspec.yaml:"
        if (Test-Path "pubspec.yaml") { echo "pubspec.yaml å­˜åœ¨" } else { echo "pubspec.yaml ä¸å­˜åœ¨" }
      shell: powershell
    
    - name: è·å–ä¾èµ–
      run: flutter pub get
    
    - name: æ„å»º Windows åº”ç”¨
      run: flutter build windows --release
    
    - name: åˆ›å»º Windows å‹ç¼©åŒ…
      run: |
        mkdir windows-package
        xcopy build\windows\x64\runner\Release windows-package\ /E /I
        Compress-Archive -Path windows-package\* -DestinationPath ç‰©èµ„åä½œå¼Šå·¥å…·-Windows-x64.zip
      shell: powershell
    
    - name: ä¸Šä¼  Windows æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: ç‰©èµ„åä½œå¼Šå·¥å…·-Windows-x64.zip

  build-macos:
    runs-on: macos-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: å¯ç”¨ macOS æ¡Œé¢æ”¯æŒ
      run: flutter config --enable-macos-desktop
    
    - name: è·å–ä¾èµ–
      run: flutter pub get
    
    - name: æ„å»º macOS åº”ç”¨
      run: flutter build macos --release
    
    - name: åˆ›å»º macOS å‹ç¼©åŒ…
      run: |
        cd build/macos/Build/Products/Release
        zip -r "../../../../../ç‰©èµ„åä½œå¼Šå·¥å…·-macOS.zip" material_anticheat.app
    
    - name: ä¸Šä¼  macOS æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: ç‰©èµ„åä½œå¼Šå·¥å…·-macOS.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
    
    - name: å®‰è£… Linux ä¾èµ–
      run: |
        sudo apt-get update -y
        sudo apt-get install -y ninja-build libgtk-3-dev
        
    - name: å¯ç”¨ Linux æ¡Œé¢æ”¯æŒ
      run: flutter config --enable-linux-desktop
    
    - name: è·å–ä¾èµ–
      run: flutter pub get
    
    - name: æ„å»º Linux åº”ç”¨
      run: flutter build linux --release
    
    - name: åˆ›å»º Linux å‹ç¼©åŒ…
      run: |
        cd build/linux/x64/release/bundle
        tar -czf "../../../../../ç‰©èµ„åä½œå¼Šå·¥å…·-Linux-x64.tar.gz" ./*
    
    - name: ä¸Šä¼  Linux æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: ç‰©èµ„åä½œå¼Šå·¥å…·-Linux-x64.tar.gz

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
    
    - name: è·å–å½“å‰æ—¥æœŸ
      id: date
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
    
    - name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.date.outputs.date }}-${{ github.run_number }}
        name: ç‰©èµ„åä½œå¼Šå·¥å…· v${{ steps.date.outputs.date }}
        body: |
          ğŸš€ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
          
          ## åŒ…å«å¹³å°
          - âœ… Windows x64
          - âœ… macOS (Intel & Apple Silicon)
          - âœ… Linux x64
          
          ## ä¸»è¦åŠŸèƒ½
          - å•æ—¥å›¾ç‰‡ä¸‹è½½
          - æ‰¹é‡å¤šæ—¥ä¸‹è½½
          - å›¾ç‰‡åº“æŸ¥çœ‹
          - ä¸‹è½½é€Ÿåº¦æ§åˆ¶
          
          ## ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
          2. è§£å‹åè¿è¡Œåº”ç”¨ç¨‹åº
          3. è¾“å…¥è®¤è¯ä¿¡æ¯å¼€å§‹ä½¿ç”¨
          
          æ„å»ºæ—¶é—´: ${{ steps.date.outputs.date }}
          æ„å»ºå·: ${{ github.run_number }}
        files: |
          windows-build/ç‰©èµ„åä½œå¼Šå·¥å…·-Windows-x64.zip
          macos-build/ç‰©èµ„åä½œå¼Šå·¥å…·-macOS.zip
          linux-build/ç‰©èµ„åä½œå¼Šå·¥å…·-Linux-x64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 